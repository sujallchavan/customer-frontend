<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Orders</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
      }
      .table-responsive {
        overflow-x: auto;
      }
      .search-box {
        width: 250px;
      }
      .modal-lg {
        max-width: 800px;
      }
      .supplier-highlight {
        background-color: rgba(25, 135, 84, 0.1);
      }
      .response-accepted {
        color: #198754;
        font-weight: 500;
      }
      .response-rejected {
        color: #dc3545;
        font-weight: 500;
      }
      .customer-id {
        font-family: monospace;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">Your Orders</h5>
          <div class="search-box">
            <input
              type="text"
              id="searchOrders"
              class="form-control form-control-sm"
              placeholder="Search orders..."
            />
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Customer ID</th>
                  <th>Project</th>
                  <th>Part Name</th>
                  <th>Status</th>
                  <th>Supplier</th>
                  <th>Response</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <tr id="loadingRow">
                  <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div
      class="modal fade"
      id="orderDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="orderModalTitle">Order Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="orderModalBody">
            <!-- Dynamic content will be inserted here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // 1. Get customer data from session storage
        const customerData = sessionStorage.getItem("customer");
        if (!customerData) {
          showError("Please login to view orders", true); // redirect to login
          return;
        }

        let customer;
        try {
          customer = JSON.parse(customerData);
          if (!customer.customer_id) throw new Error("Invalid customer data");
        } catch (e) {
          showError("Invalid session data", true);
          return;
        }

        // 2. Initialize elements
        const ordersTable = document.getElementById("ordersTableBody");
        const searchInput = document.getElementById("searchOrders");
        const orderModal = new bootstrap.Modal("#orderDetailsModal");

        // 3. Enhanced loadOrders function with better error handling
        async function loadOrders() {
          showLoading();

          try {
            const response = await fetch(
              `https://backend-api-dtwc.onrender.com/api/customer/orders/${customer.customer_id}`,
              {
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${
                    sessionStorage.getItem("token") || ""
                  }`,
                },
              }
            );

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.message || `HTTP error! status: ${response.status}`
              );
            }

            const orders = await response.json();

            if (!Array.isArray(orders)) {
              throw new Error("Invalid data format received");
            }

            // Filter out disapproved orders
            const approvedOrders = orders.filter(
              (order) =>
                order.isApproved !== "Disapproved" && order.isApproved !== false
            );

            displayOrders(approvedOrders);
          } catch (error) {
            console.error("Order loading error:", error);
            showError(`Failed to load orders: ${error.message}`);

            // Specific handling for 401 unauthorized
            if (error.message.includes("401")) {
              setTimeout(() => (window.location.href = "login.html"), 2000);
            }
          }
        }

        // 4. Modified displayOrders function to show orders multiple times for multiple accepted suppliers
        function displayOrders(orders) {
          if (!orders || !orders.length) {
            ordersTable.innerHTML = `
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                  <i class="fas fa-box-open me-2"></i>No approved orders found
                </td>
              </tr>`;
            return;
          }

          // Create an array to hold all order rows (including duplicates for multiple suppliers)
          const allOrderRows = [];

          orders.forEach((order) => {
            const supplierResponses = order.supplierResponses || [];
            const totalResponses = supplierResponses.length;

            // If no responses, show the order once
            if (supplierResponses.length === 0) {
              allOrderRows.push(createOrderRow(order, null, totalResponses));
            }
            // If responses exist, create a row for each response
            else {
              supplierResponses.forEach((response) => {
                allOrderRows.push(
                  createOrderRow(order, response, totalResponses)
                );
              });
            }
          });

          ordersTable.innerHTML = allOrderRows.join("");

          // Add event listeners to view buttons
          document.querySelectorAll(".view-order").forEach((btn) => {
            btn.addEventListener("click", () => {
              try {
                showOrderDetails(btn.dataset.order);
              } catch (e) {
                console.error("Error showing order:", e);
                alert("Couldn't show order details");
              }
            });
          });
        }

        // Helper function to create a single order row
        function createOrderRow(order, response, totalResponses) {
          const hasResponse = response !== null;
          const isAccepted = hasResponse && response.status === "Accepted";

          return `
            <tr ${isAccepted ? 'class="supplier-highlight"' : ""}>
              <td>${order.order_id || "N/A"}</td>
              <td class="customer-id">${
                order.customer_id || customer.customer_id || "N/A"
              }</td>
              <td>${order.pname || "Unnamed Project"}</td>
              <td>${order.Part_Name || "No part specified"}</td>
              <td>
                <span class="badge ${getStatusBadgeClass(
                  order.working_status
                )}">
                  ${order.working_status || "Unknown"}
                </span>
              </td>
              <td>
                ${
                  hasResponse
                    ? `Supplier ID: ${response.supplier_Id || "N/A"}`
                    : "No responses"
                }
                <small class="text-muted"> (${totalResponses} total responses)</small>
              </td>
              <td>
                ${
                  hasResponse
                    ? `<span class="${
                        response.status === "Accepted"
                          ? "response-accepted"
                          : "response-rejected"
                      }">
                        <i class="fas ${
                          response.status === "Accepted"
                            ? "fa-check-circle"
                            : "fa-times-circle"
                        } me-1"></i>
                        ${response.status || "Unknown"}
                      </span>`
                    : '<span class="text-muted">No response</span>'
                }
              </td>
              <td>
                <button class="btn btn-sm btn-primary view-order" 
                        data-order='${JSON.stringify(order)}'>
                  <i class="fas fa-eye me-1"></i> View
                </button>
              </td>
            </tr>`;
        }

        // 5. Helper functions
        function showLoading() {
          ordersTable.innerHTML = `
              <tr id="loadingRow">
                <td colspan="8" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 mb-0">Loading your orders...</p>
                </td>
              </tr>`;
        }

        function showError(message, redirect = false) {
          ordersTable.innerHTML = `
              <tr>
                <td colspan="8" class="text-center py-4 text-danger">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  ${message}
                  ${redirect ? "<p>Redirecting to login...</p>" : ""}
                </td>
              </tr>`;

          if (redirect) {
            setTimeout(() => (window.location.href = "login.html"), 2000);
          }
        }

        function getStatusBadgeClass(status) {
          if (!status) return "bg-secondary";
          switch (status.toLowerCase()) {
            case "completed":
              return "bg-success";
            case "accepted":
              return "bg-success";
            case "working":
            case "in progress":
              return "bg-warning";
            case "pending":
              return "bg-warning";
            case "rejected":
            case "failed":
              return "bg-danger";
            default:
              return "bg-secondary";
          }
        }

        function showOrderDetails(orderData) {
          try {
            const order =
              typeof orderData === "string" ? JSON.parse(orderData) : orderData;
            const modalTitle = document.getElementById("orderModalTitle");
            const modalBody = document.getElementById("orderModalBody");

            modalTitle.textContent = `Order Details - #${order.order_id}`;

            // Get accepted suppliers
            const acceptedSuppliers =
              order.supplierResponses?.filter(
                (r) => r?.status === "Accepted"
              ) || [];

            modalBody.innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <h6>Project Information</h6>
                  <p><strong>Customer ID:</strong> ${
                    order.customer_id || customer.customer_id || "N/A"
                  }</p>
                  <p><strong>Project Name:</strong> ${order.pname || "N/A"}</p>
                  <p><strong>Part Name:</strong> ${order.Part_Name || "N/A"}</p>
                  <p><strong>Description:</strong> ${
                    order.description || "No description"
                  }</p>
                </div>
                <div class="col-md-6">
                  <h6>Order Status</h6>
                  <p><strong>Status:</strong> 
                    <span class="badge ${getStatusBadgeClass(
                      order.working_status
                    )}">
                      ${order.working_status || "Unknown"}
                    </span>
                  </p>
                  <p><strong>Created:</strong> ${
                    order.createdAt || "Unknown date"
                  }</p>
                  <p><strong>Approval Status:</strong> 
                    <span class="badge ${
                      order.isApproved === true ||
                      order.isApproved === "Approved"
                        ? "bg-success"
                        : "bg-danger"
                    }">
                      ${
                        order.isApproved === true ||
                        order.isApproved === "Approved"
                          ? "Approved"
                          : "Disapproved"
                      }
                    </span>
                  </p>
                </div>
              </div>
              
              <div class="mb-3">
                <h6>Supplier Responses</h6>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Supplier ID</th>
                        <th>Status</th>
                        <th>Response Date</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${
                        order.supplierResponses &&
                        order.supplierResponses.length
                          ? order.supplierResponses
                              .map(
                                (response) => `
                              <tr class="${
                                response.status === "Accepted"
                                  ? "table-success"
                                  : "table-light"
                              }">
                                <td>${response.supplier_Id || "N/A"}</td>
                                <td>${response.status || "N/A"}</td>
                                <td>${response.responseDate || "Unknown"}</td>
                              </tr>
                            `
                              )
                              .join("")
                          : '<tr><td colspan="3" class="text-muted">No supplier responses yet</td></tr>'
                      }
                    </tbody>
                  </table>
                </div>
              </div>
              
              ${
                acceptedSuppliers.length > 0
                  ? `
                <div class="alert alert-success">
                  <i class="fas fa-check-circle me-2"></i>
                  This order has been accepted by ${acceptedSuppliers.length} supplier(s)
                </div>
              `
                  : ""
              }
            `;

            orderModal.show();
          } catch (e) {
            console.error("Error showing order details:", e);
            alert("Failed to display order details");
          }
        }

        // 6. Initialize
        loadOrders();

        // Search functionality
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const rows = ordersTable.querySelectorAll("tr");

          rows.forEach((row) => {
            if (row.id === "loadingRow") return;

            const orderId = row.cells[0].textContent.toLowerCase();
            const customerId = row.cells[1].textContent.toLowerCase();
            const projectName = row.cells[2].textContent.toLowerCase();
            const supplierInfo = row.cells[5].textContent.toLowerCase();
            const responseStatus = row.cells[6].textContent.toLowerCase();

            if (
              orderId.includes(searchTerm) ||
              customerId.includes(searchTerm) ||
              projectName.includes(searchTerm) ||
              supplierInfo.includes(searchTerm) ||
              responseStatus.includes(searchTerm)
            ) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });
      });
    </script>
  </body>
</html>
